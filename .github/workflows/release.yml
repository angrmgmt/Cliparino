name: Release

on:
  push:
    tags:
      - 'v*'

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Extract version from tag
      id: version
      shell: bash
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Update version in project file
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $csproj = "src/Cliparino.Core/Cliparino.Core.csproj"
        $content = Get-Content $csproj -Raw
        $content = $content -replace '<Version>.*?</Version>', "<Version>$version</Version>"
        $content = $content -replace '<AssemblyVersion>.*?</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $content = $content -replace '<FileVersion>.*?</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $csproj $content

    - name: Restore dependencies
      run: dotnet restore Cliparino.sln

    - name: Build solution
      run: dotnet build Cliparino.sln --configuration Release --no-restore

    - name: Run tests
      run: dotnet test Cliparino.sln --configuration Release --no-build --verbosity normal

    - name: Restore for publish (with runtime)
      run: dotnet restore src/Cliparino.Core/Cliparino.Core.csproj --runtime win-x64

    - name: Publish self-contained application
      run: dotnet publish src/Cliparino.Core/Cliparino.Core.csproj --configuration Release --runtime win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true --output src/Cliparino.Core/bin/Release/net8.0-windows/win-x64/publish

    - name: Verify publish output
      shell: pwsh
      run: |
        $publishDir = "src/Cliparino.Core/bin/Release/net8.0-windows/win-x64/publish"
        Write-Host "Checking publish directory: $publishDir"
        if (-not (Test-Path $publishDir)) {
          Write-Error "Publish directory does not exist!"
          exit 1
        }
        Write-Host "Published files:"
        Get-ChildItem -Path $publishDir -Recurse | ForEach-Object {
          $size = if ($_.PSIsContainer) { "" } else { " ($([math]::Round($_.Length/1MB, 2)) MB)" }
          Write-Host "$($_.FullName)$size"
        }

        $exe = Join-Path $publishDir "Cliparino.Core.exe"
        if (-not (Test-Path $exe)) {
          Write-Error "Cliparino.Core.exe not found in publish output!"
          exit 1
        }

        $exeSize = (Get-Item $exe).Length / 1MB
        Write-Host "Executable size: $([math]::Round($exeSize, 2)) MB"

        if ($exeSize -lt 50) {
          Write-Error "Executable is too small ($([math]::Round($exeSize, 2)) MB) - self-contained publish likely failed!"
          exit 1
        }
        Write-Host "Executable size verification passed"

    - name: Create output directory
      shell: pwsh
      run: New-Item -ItemType Directory -Force -Path out

    - name: Install Inno Setup
      shell: pwsh
      run: |
        choco install innosetup --yes --no-progress
        echo "C:\Program Files (x86)\Inno Setup 6" >> $env:GITHUB_PATH

    - name: Update installer version
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $issFile = "installer/Cliparino.iss"
        $content = Get-Content $issFile -Raw
        $content = $content -replace '#define MyAppVersion ".*?"', "#define MyAppVersion `"$version`""
        Set-Content $issFile $content

    - name: Compile installer
      shell: pwsh
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer/Cliparino.iss"

    - name: List output directory
      shell: pwsh
      run: Get-ChildItem -Path out -Recurse

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: Cliparino v${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
        generate_release_notes: true
        files: |
          out/Cliparino-${{ steps.version.outputs.VERSION }}-Setup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: installer
        path: out/Cliparino-*.exe
        retention-days: 30
